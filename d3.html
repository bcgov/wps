<html>
  <head>
    <style>
      text {
        font-family: "Helvetica Neue", Helvetica, sans-serif;
        fill: white;
        font-size: 15px;
      }
    </style>
  </head>
  <body style="background-color: #101010">
    <svg
      id="viz"
      height="200"
      width="600"
      style="border-color: green; border-width: 1px; border-style: solid"
    ></svg>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script>
      const svg = d3.select("#viz");

      const data = [
        {
          text: "Short",
          group: 0,
          color: "blue",
          shape: { type: "cross", size: 45 },
        },
        {
          text: "Longer can be problematic",
          group: 0,
          color: "purple",
          shape: { type: "rect", r: 5 },
        },
        {
          text: "Observed Temp",
          group: 1,
          color: "red",
          shape: { type: "diamond", size: 15 },
        },
        {
          text: "Observed RH",
          group: 1,
          color: "green",
          fill: "none",
          shape: { type: "circle", r: 5 },
        },
        {
          text: "Forecast Temp",
          color: "yellow",
          group: 2,
          shape: { type: "circle", r: 5 },
        },
        {
          text: "Forecast RH",
          color: "orange",
          group: 2,
          shape: { type: "circle", r: 5 },
        },
        {
          text: "GDPS Temp",
          group: 3,
          color: "pink",
          shape: { type: "circle", r: 5 },
        },
      ];

      function create_icon(item, d) {
        if (d.shape.type === "circle") {
          console.log(d.fill, d.fill || d.color);
          return item
            .append(d.shape.type)
            .attr("r", d.shape.r)
            .style("stroke", d.color)
            .style("fill", d.fill || d.color);
        } else if (d.shape.type === "rect") {
          return item
            .append(d.shape.type)
            .attr("width", 10)
            .attr("height", 10)
            .style("stroke", d.color)
            .style("fill", d.fill || d.color);
        } else if (d.shape.type === "diamond") {
          return item
            .append("path")
            .attr("d", d3.symbol().type(d3.symbolDiamond).size(d.shape.size))
            .style("stroke", d.color)
            .attr("fill", d.fill || d.color);
        } else if (d.shape.type === "triangle") {
          return item
            .append("path")
            .attr("d", d3.symbol().type(d3.symbolTriangle).size(d.shape.size))
            .style("stroke", d.color)
            .attr("fill", d.fill || d.color);
        } else if (d.shape.type === "cross") {
          return item
            .append("path")
            .attr("d", d3.symbol().type(d3.symbolCross).size(d.shape.size))
            .style("stroke", d.color)
            .attr("fill", d.fill || d.color);
        }
      }

      function translate_icon(shape, x_offset, y_offset, icon, text) {
        const delta = Math.abs(
          icon.node().getBBox().height - text.node().getBBox().height / 2
        );
        if (shape.type === "diamond") {
          const x = x_offset + icon.node().getBBox().width / 2;
          const y = y_offset - delta;
          return `translate(${x}, ${y})`;
        } else if (shape.type === "circle") {
          const x = x_offset + icon.node().getBBox().width / 2;
          const y = y_offset - delta;
          return `translate(${x}, ${y})`;
        } else if (shape.type === "rect") {
          const x = x_offset;
          const y = y_offset - icon.node().getBBox().height / 2 - delta;
          return `translate(${x}, ${y})`;
        } else if (shape.type === "cross") {
          const x = x_offset + icon.node().getBBox().width / 2;
          const y = y_offset - delta;
          return `translate(${x}, ${y})`;
        }
        return;
        `translate(${x_offset + icon.node().getBBox().width / 2}, {y_offset}`;
      }

      const legend = svg.selectAll(".legend").data(data);

      let group = data[0].group;
      const x_margin = 5;
      const y_margin = 5;
      let x_offset = 0;
      let y_offset = 5 + y_margin;
      const max_width = 400;
      legend
        .enter()
        .append("g")
        .attr("transform", "translate(0, 0)")
        .attr("class", "legend")
        .each(function (d, i) {
          const item = d3.select(this);
          // x_offset += x_margin;

          const text = item
            .append("text")
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .style("fill", (d) => d.color)
            .text(d.text);

          const icon = create_icon(item, d);
          if (icon) {
            icon.attr(
              "transform",
              translate_icon(d.shape, x_offset, y_offset, icon, text)
            );
          }
          x_offset += x_margin;
          text.attr(
            "transform",
            "translate(" +
              (x_offset + icon.node().getBBox().width) +
              ", " +
              y_offset +
              ")"
          );

          x_offset +=
            icon.node().getBBox().width +
            text.node().getBBox().width +
            x_margin;
          return;

          if (d.group !== group) {
            x_offset = x_margin;
            y_offset += text.node().getBBox().height + y_margin;
            icon.attr(
              "transform",
              translate_icon(d.shape, x_offset, y_offset, icon, text)
            );
            icon_width = icon.node().getBBox().width;
            x_offset += icon_width;
            x_offset += x_margin;
            text.attr(
              "transform",
              "translate(" + x_offset + ", " + y_offset + ")"
            );
            group = d.group;
            x_offset += text.node().getBBox().width;
          } else {
            x_offset += icon_width + text.node().getBBox().width;
          }
          //    else {
          //     x_offset += icon_width + text.node().getBBox().width;
          //     if (x_offset > max_width) {
          //       y_offset += text.node().getBBox().height;
          //       text.attr("transform", "translate(0, " + y_offset + ")");
          //       x_offset = text.node().getBBox().width;
          //     }
          //   }
          //   console.log(text.node().getBBox().width);
        });

      //   svg
      //     .selectAll("mydots")
      //     .data(data)
      //     .enter()
      //     .append("circle")
      //     .attr("cx", function () {
      //       return 10;
      //     })
      //     .attr("cy", (d, i) => 40 + i * 25)
      //     .attr("r", 7)
      //     .style("fill", (d) => d.color);

      //   svg
      //     .selectAll("mylabels")
      //     .data(data)
      //     .enter()
      //     .append("text")
      //     .attr("x", function () {
      //       if (
      //         this.previousSibling &&
      //         this.previousSibling.nodeName === "text"
      //       ) {
      //       }
      //       return 30;
      //     })
      //     .attr("y", (d, i) => 40 + i * 25)
      //     .style("fill", (d) => d.color)
      //     .text((d) => d.text)
      //     .attr("text-anchor", "left")
      //     .style("alignment-baseline", "middle");

      //   function myLayout() {
      //     let space = 1;
      //     function compute(data) {
      //       return data;
      //     }
      //     compute.space = function (s) {
      //       return this;
      //     };
      //     return compute;
      //   }
      //   const layout = myLayout().space(10);
      //   const nodes = layout(data);
    </script>
  </body>
</html>
