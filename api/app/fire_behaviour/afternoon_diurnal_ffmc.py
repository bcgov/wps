import logging
import math
from typing import Optional
import pandas as pd
from app.utils.singleton import Singleton

logger = logging.getLogger(__name__)


@Singleton
class AfternoonDiurnalFFMCLookupTable():
    """ Dataframe singleton of the standard diurnal FFMC lookup table (Table 1) from 
    Diurnal Variation in the Fine Fuel Moisture Code: Tables and Computer Source Code
    Lawson et al, 1996 (https://www.for.gov.bc.ca/hfd/pubs/docs/frr/Frr245.htm).

    FFMC values are indexed by a tuple of (noon LST FFMC, LST hour).
    """

    def __init__(self):
        data = [
            # 50 range
            (50, 12, 40.9),
            (50, 13, 43.2),
            (50, 14, 45.6),
            (50, 15, 47.8),
            (50, 16, 50.0),
            (50, 17, 51.0),
            (50, 18, 52.0),
            (50, 19, 52.6),
            (50, 20, 53.3),
            (50, 21, 52.1),
            (50, 22, 51.0),
            (50, 23, 50.0),
            (50, 24, 48.9),
            (50, 1, 47.8),
            (50, 2, 46.8),
            (50, 3, 45.8),
            (50, 4, 44.8),
            (50, 5, 43.9),
            (50, 6, 42.9),

            # 60 range
            (60, 12, 48.2),
            (60, 13, 51.5),
            (60, 14, 54.8),
            (60, 15, 57.4),
            (60, 16, 60.0),
            (60, 17, 61.0),
            (60, 18, 62.0),
            (60, 19, 62.0),
            (60, 20, 62.0),
            (60, 21, 60.5),
            (60, 22, 59.1),
            (60, 23, 57.6),
            (60, 24, 56.3),
            (60, 1, 54.9),
            (60, 2, 53.6),
            (60, 3, 52.3),
            (60, 4, 51.0),
            (60, 5, 49.8),
            (60, 6, 48.6),

            # 70 range
            (70, 12, 57.3),
            (70, 13, 61.0),
            (70, 14, 65.1),
            (70, 15, 67.5),
            (70, 16, 70.0),
            (70, 17, 70.4),
            (70, 18, 70.7),
            (70, 19, 70.0),
            (70, 20, 69.4),
            (70, 21, 67.8),
            (70, 22, 66.2),
            (70, 23, 64.7),
            (70, 24, 63.3),
            (70, 1, 61.8),
            (70, 2, 60.4),
            (70, 3, 59.0),
            (70, 4, 57.7),
            (70, 5, 56.4),
            (70, 6, 55.1),

            # 72 range
            (72, 12, 59.4),
            (72, 13, 63.2),
            (72, 14, 67.3),
            (72, 15, 69.6),
            (72, 16, 72.0),
            (72, 17, 72.2),
            (72, 18, 72.3),
            (72, 19, 71.6),
            (72, 20, 70.9),
            (72, 21, 69.3),
            (72, 22, 67.7),
            (72, 23, 66.2),
            (72, 24, 64.7),
            (72, 1, 63.3),
            (72, 2, 61.8),
            (72, 3, 60.5),
            (72, 4, 59.1),
            (72, 5, 57.8),
            (72, 6, 56.5),

            # 74 range
            (74, 12, 61.7),
            (74, 13, 65.5),
            (74, 14, 69.6),
            (74, 15, 71.8),
            (74, 16, 74.0),
            (74, 17, 74.0),
            (74, 18, 74.0),
            (74, 19, 73.2),
            (74, 20, 72.4),
            (74, 21, 70.8),
            (74, 22, 69.2),
            (74, 23, 67.2),
            (74, 24, 66.2),
            (74, 1, 64.8),
            (74, 2, 63.4),
            (74, 3, 62.0),
            (74, 4, 60.6),
            (74, 5, 59.3),
            (74, 6, 58.0),

            # 75 range
            (75, 12, 62.9),
            (75, 13, 66.7),
            (75, 14, 70.8),
            (75, 15, 72.9),
            (75, 16, 75.0),
            (75, 17, 75.0),
            (75, 18, 74.9),
            (75, 19, 74.0),
            (75, 20, 73.1),
            (75, 21, 71.5),
            (75, 22, 70.0),
            (75, 23, 68.5),
            (75, 24, 67.0),
            (75, 1, 65.5),
            (75, 2, 64.1),
            (75, 3, 62.7),
            (75, 4, 61.4),
            (75, 5, 60.1),
            (75, 6, 58.8),

            # 76 range
            (76, 12, 64.2),
            (76, 13, 67.9),
            (76, 14, 72.0),
            (76, 15, 74.0),
            (76, 16, 76.0),
            (76, 17, 75.9),
            (76, 18, 75.7),
            (76, 19, 74.8),
            (76, 20, 73.9),
            (76, 21, 72.3),
            (76, 22, 70.8),
            (76, 23, 69.3),
            (76, 24, 67.8),
            (76, 1, 66.3),
            (76, 2, 64.9),
            (76, 3, 63.5),
            (76, 4, 62.2),
            (76, 5, 60.8),
            (76, 6, 59.6),

            # 77 range
            (77, 12, 65.5),
            (77, 13, 69.3),
            (77, 14, 73.3),
            (77, 15, 75.1),
            (77, 16, 77.0),
            (77, 17, 76.8),
            (77, 18, 76.6),
            (77, 19, 75.7),
            (77, 20, 74.7),
            (77, 21, 73.1),
            (77, 22, 71.6),
            (77, 23, 70.1),
            (77, 24, 68.6),
            (77, 1, 67.1),
            (77, 2, 65.7),
            (77, 3, 64.3),
            (77, 4, 63.0),
            (77, 5, 61.6),
            (77, 6, 60.4),

            # 78 range
            (78, 12, 66.9),
            (78, 13, 70.7),
            (78, 14, 74.6),
            (78, 15, 76.3),
            (78, 16, 78.0),
            (78, 17, 77.8),
            (78, 18, 77.5),
            (78, 19, 76.5),
            (78, 20, 75.5),
            (78, 21, 73.9),
            (78, 22, 72.4),
            (78, 23, 70.9),
            (78, 24, 69.4),
            (78, 1, 67.9),
            (78, 2, 66.5),
            (78, 3, 65.1),
            (78, 4, 63.8),
            (78, 5, 62.5),
            (78, 6, 61.2),

            # 79 range
            (79, 12, 68.5),
            (79, 13, 72.2),
            (79, 14, 76.1),
            (79, 15, 77.5),
            (79, 16, 79.0),
            (79, 17, 78.7),
            (79, 18, 78.4),
            (79, 19, 77.4),
            (79, 20, 76.3),
            (79, 21, 74.8),
            (79, 22, 73.2),
            (79, 23, 71.7),
            (79, 24, 70.2),
            (79, 1, 68.8),
            (79, 2, 67.4),
            (79, 3, 66.0),
            (79, 4, 64.6),
            (79, 5, 63.3),
            (79, 6, 62.0),

            # 80 range
            (80, 12, 70.5),
            (80, 13, 73.9),
            (80, 14, 77.4),
            (80, 15, 78.7),
            (80, 16, 80.0),
            (80, 17, 79.7),
            (80, 18, 79.3),
            (80, 19, 78.2),
            (80, 20, 77.2),
            (80, 21, 75.6),
            (80, 22, 74.1),
            (80, 23, 72.5),
            (80, 24, 71.1),
            (80, 1, 69.6),
            (80, 2, 68.2),
            (80, 3, 66.8),
            (80, 4, 65.5),
            (80, 5, 64.2),
            (80, 6, 62.9),

            # 81 range
            (81, 12, 73.8),
            (81, 13, 76.3),
            (81, 14, 78.7),
            (81, 15, 79.9),
            (81, 16, 81.0),
            (81, 17, 80.6),
            (81, 18, 80.2),
            (81, 19, 79.1),
            (81, 20, 78.0),
            (81, 21, 76.5),
            (81, 22, 74.9),
            (81, 23, 73.4),
            (81, 24, 71.9),
            (81, 1, 70.5),
            (81, 2, 69.1),
            (81, 3, 67.7),
            (81, 4, 66.3),
            (81, 5, 65.0),
            (81, 6, 63.8),

            # 82 range
            (82, 12, 76.4),
            (82, 13, 78.2),
            (82, 14, 79.9),
            (82, 15, 81.0),
            (82, 16, 82.0),
            (82, 17, 81.6),
            (82, 18, 81.2),
            (82, 19, 80.0),
            (82, 20, 78.9),
            (82, 21, 77.3),
            (82, 22, 75.8),
            (82, 23, 74.3),
            (82, 24, 72.8),
            (82, 1, 71.4),
            (82, 2, 70.0),
            (82, 3, 68.6),
            (82, 4, 67.2),
            (82, 5, 65.9),
            (82, 6, 64.6),

            # 83 range
            (83, 12, 78.4),
            (83, 13, 79.8),
            (83, 14, 81.1),
            (83, 15, 82.1),
            (83, 16, 83.0),
            (83, 17, 82.6),
            (83, 18, 82.1),
            (83, 19, 80.9),
            (83, 20, 79.8),
            (83, 21, 78.2),
            (83, 22, 76.7),
            (83, 23, 75.2),
            (83, 24, 73.7),
            (83, 1, 72.3),
            (83, 2, 70.9),
            (83, 3, 69.5),
            (83, 4, 68.1),
            (83, 5, 66.8),
            (83, 6, 65.6),

            # 84 range
            (84, 12, 80.0),
            (84, 13, 81.1),
            (84, 14, 82.3),
            (84, 15, 83.2),
            (84, 16, 84.0),
            (84, 17, 83.5),
            (84, 18, 83.0),
            (84, 19, 81.8),
            (84, 20, 80.6),
            (84, 21, 79.1),
            (84, 22, 77.6),
            (84, 23, 76.1),
            (84, 24, 74.6),
            (84, 1, 73.2),
            (84, 2, 71.8),
            (84, 3, 70.4),
            (84, 4, 69.1),
            (84, 5, 67.8),
            (84, 6, 66.5),

            # 85 range
            (85, 12, 81.5),
            (85, 13, 82.4),
            (85, 14, 83.4),
            (85, 15, 84.2),
            (85, 16, 85.0),
            (85, 17, 84.5),
            (85, 18, 84.0),
            (85, 19, 82.8),
            (85, 20, 81.5),
            (85, 21, 80.0),
            (85, 22, 78.5),
            (85, 23, 77.0),
            (85, 24, 75.5),
            (85, 1, 74.1),
            (85, 2, 72.7),
            (85, 3, 71.4),
            (85, 4, 70.0),
            (85, 5, 68.7),
            (85, 6, 67.5),

            # 86 range
            (86, 12, 82.8),
            (86, 13, 83.7),
            (86, 14, 84.6),
            (86, 15, 85.3),
            (86, 16, 86.0),
            (86, 17, 85.5),
            (86, 18, 84.9),
            (86, 19, 83.7),
            (86, 20, 82.5),
            (86, 21, 80.9),
            (86, 22, 79.4),
            (86, 23, 77.9),
            (86, 24, 76.5),
            (86, 1, 75.1),
            (86, 2, 73.7),
            (86, 3, 72.3),
            (86, 4, 71.0),
            (86, 5, 69.7),
            (86, 6, 68.4),

            # 87 range
            (87, 12, 84.0),
            (87, 13, 84.8),
            (87, 14, 85.7),
            (87, 15, 86.4),
            (87, 16, 87.0),
            (87, 17, 86.5),
            (87, 18, 85.9),
            (87, 19, 84.6),
            (87, 20, 83.4),
            (87, 21, 81.9),
            (87, 22, 80.4),
            (87, 23, 78.9),
            (87, 24, 77.5),
            (87, 1, 76.1),
            (87, 2, 74.7),
            (87, 3, 73.3),
            (87, 4, 72.0),
            (87, 5, 70.7),
            (87, 6, 69.5),

            # 88 range
            (88, 12, 85.2),
            (88, 13, 86.0),
            (88, 14, 86.8),
            (88, 15, 87.4),
            (88, 16, 88.0),
            (88, 17, 87.5),
            (88, 18, 86.9),
            (88, 19, 85.6),
            (88, 20, 84.3),
            (88, 21, 82.8),
            (88, 22, 81.3),
            (88, 23, 79.9),
            (88, 24, 78.5),
            (88, 1, 77.1),
            (88, 2, 75.7),
            (88, 3, 74.4),
            (88, 4, 78.0),
            (88, 5, 71.7),
            (88, 6, 70.5),

            # 89 range
            (89, 12, 86.3),
            (89, 13, 87.1),
            (89, 14, 87.9),
            (89, 15, 88.5),
            (89, 16, 89.0),
            (89, 17, 88.5),
            (89, 18, 87.9),
            (89, 19, 86.6),
            (89, 20, 85.3),
            (89, 21, 83.8),
            (89, 22, 82.3),
            (89, 23, 80.9),
            (89, 24, 79.5),
            (89, 1, 78.1),
            (89, 2, 76.7),
            (89, 3, 75.4),
            (89, 4, 74.1),
            (89, 5, 72.8),
            (89, 6, 71.6),

            # 90 range
            (90, 12, 87.5),
            (90, 13, 88.2),
            (90, 14, 88.9),
            (90, 15, 89.5),
            (90, 16, 90.0),
            (90, 17, 89.5),
            (90, 18, 88.9),
            (90, 19, 87.5),
            (90, 20, 86.2),
            (90, 21, 84.8),
            (90, 22, 83.3),
            (90, 23, 81.9),
            (90, 24, 80.5),
            (90, 1, 79.1),
            (90, 2, 77.8),
            (90, 3, 76.5),
            (90, 4, 75.2),
            (90, 5, 73.9),
            (90, 6, 72.7),

            # 91 range
            (91, 12, 88.6),
            (91, 13, 89.3),
            (91, 14, 90.0),
            (91, 15, 90.5),
            (91, 16, 91.0),
            (91, 17, 90.5),
            (91, 18, 89.9),
            (91, 19, 88.5),
            (91, 20, 87.2),
            (91, 21, 85.8),
            (91, 22, 84.3),
            (91, 23, 82.9),
            (91, 24, 81.5),
            (91, 1, 80.2),
            (91, 2, 78.9),
            (91, 3, 77.6),
            (91, 4, 76.3),
            (91, 5, 75.0),
            (91, 6, 73.8),

            # 92 range
            (92, 12, 89.7),
            (92, 13, 90.4),
            (92, 14, 91.0),
            (92, 15, 91.5),
            (92, 16, 92.1),
            (92, 17, 91.5),
            (92, 18, 90.9),
            (92, 19, 89.5),
            (92, 20, 88.2),
            (92, 21, 86.8),
            (92, 22, 85.4),
            (92, 23, 84.0),
            (92, 24, 82.6),
            (92, 1, 81.3),
            (92, 2, 80.0),
            (92, 3, 78.7),
            (92, 4, 77.4),
            (92, 5, 76.2),
            (92, 6, 75.0),

            # 93 range
            (93, 12, 90.8),
            (93, 13, 91.4),
            (93, 14, 92.1),
            (93, 15, 92.6),
            (93, 16, 93.1),
            (93, 17, 92.5),
            (93, 18, 91.9),
            (93, 19, 90.5),
            (93, 20, 89.2),
            (93, 21, 87.8),
            (93, 22, 86.4),
            (93, 23, 85.0),
            (93, 24, 83.7),
            (93, 1, 82.4),
            (93, 2, 81.1),
            (93, 3, 79.8),
            (93, 4, 78.6),
            (93, 5, 77.4),
            (93, 6, 76.2),

            # 94 range
            (94, 12, 91.9),
            (94, 13, 92.5),
            (94, 14, 93.1),
            (94, 15, 93.6),
            (94, 16, 94.1),
            (94, 17, 93.5),
            (94, 18, 92.9),
            (94, 19, 91.5),
            (94, 20, 90.2),
            (94, 21, 88.8),
            (94, 22, 87.5),
            (94, 23, 86.1),
            (94, 24, 84.8),
            (94, 1, 83.5),
            (94, 2, 82.3),
            (94, 3, 81.0),
            (94, 4, 79.8),
            (94, 5, 78.6),
            (94, 6, 77.4),

            # 95 range
            (95, 12, 92.9),
            (95, 13, 93.5),
            (95, 14, 94.1),
            (95, 15, 94.6),
            (95, 16, 95.1),
            (95, 17, 94.5),
            (95, 18, 93.9),
            (95, 19, 92.6),
            (95, 20, 91.2),
            (95, 21, 89.8),
            (95, 22, 88.6),
            (95, 23, 87.2),
            (95, 24, 86.0),
            (95, 1, 84.7),
            (95, 2, 83.4),
            (95, 3, 82.2),
            (95, 4, 81.0),
            (95, 5, 79.8),
            (95, 6, 78.7),

            # 96 range
            (96, 12, 94.0),
            (96, 13, 94.6),
            (96, 14, 95.1),
            (96, 15, 95.6),
            (96, 16, 96.1),
            (96, 17, 95.5),
            (96, 18, 95.0),
            (96, 19, 93.6),
            (96, 20, 92.3),
            (96, 21, 90.9),
            (96, 22, 89.6),
            (96, 23, 88.4),
            (96, 24, 87.1),
            (96, 1, 85.9),
            (96, 2, 84.7),
            (96, 3, 83.5),
            (96, 4, 82.3),
            (96, 5, 81.1),
            (96, 6, 80.0),

            # 97 range
            (97, 12, 95.0),
            (97, 13, 95.6),
            (97, 14, 96.1),
            (97, 15, 96.6),
            (97, 16, 97.1),
            (97, 17, 96.5),
            (97, 18, 96.0),
            (97, 19, 94.6),
            (97, 20, 93.3),
            (97, 21, 92.0),
            (97, 22, 90.8),
            (97, 23, 89.5),
            (97, 24, 88.3),
            (97, 1, 87.1),
            (97, 2, 85.9),
            (97, 3, 83.7),
            (97, 4, 83.6),
            (97, 5, 82.5),
            (97, 6, 81.4),

            # 98 range
            (98, 12, 96.0),
            (98, 13, 96.6),
            (98, 14, 97.1),
            (98, 15, 97.6),
            (98, 16, 98.1),
            (98, 17, 97.6),
            (98, 18, 97.1),
            (98, 19, 95.7),
            (98, 20, 94.3),
            (98, 21, 93.1),
            (98, 22, 91.9),
            (98, 23, 90.7),
            (98, 24, 89.5),
            (98, 1, 88.3),
            (98, 2, 87.2),
            (98, 3, 86.0),
            (98, 4, 84.9),
            (98, 5, 83.8),
            (98, 6, 82.7),

            # 99 range
            (99, 12, 97.0),
            (99, 13, 97.6),
            (99, 14, 98.1),
            (99, 15, 98.6),
            (99, 16, 99.1),
            (99, 17, 98.6),
            (99, 18, 98.1),
            (99, 19, 96.7),
            (99, 20, 95.4),
            (99, 21, 94.2),
            (99, 22, 93.0),
            (99, 23, 91.8),
            (99, 24, 90.7),
            (99, 1, 89.5),
            (99, 2, 88.4),
            (99, 3, 87.3),
            (99, 4, 86.2),
            (99, 5, 85.2),
            (99, 6, 84.1),

            # 100 range
            (100, 12, 97.9),
            (100, 13, 98.5),
            (100, 14, 99.1),
            (100, 15, 99.6),
            (100, 16, 100),
            (100, 17, 99.6),
            (100, 18, 99.1),
            (100, 19, 97.8),
            (100, 20, 96.4),
            (100, 21, 95.2),
            (100, 22, 94.1),
            (100, 23, 92.9),
            (100, 24, 91.8),
            (100, 1, 90.7),
            (100, 2, 89.6),
            (100, 3, 88.5),
            (100, 4, 87.5),
            (100, 5, 86.4),
            (100, 6, 85.4),
        ]

        column_names = ['ffmc', 'hour', 'predicted_ffmc']
        self.afternoon_lookup = pd.DataFrame(data, columns=column_names)
        self.afternoon_lookup.set_index(['ffmc', 'hour'], inplace=True)

    def get(self, daily_ffmc: float, hour: int) -> Optional[float]:
        if daily_ffmc < 50:
            return None

        # Round up and clamp to 100 if somehow over 100
        lookup_ffmc = min(100, math.ceil(daily_ffmc))

        if lookup_ffmc in range(0, 55):
            return self.afternoon_lookup.loc[(50, hour)]['predicted_ffmc']
        elif lookup_ffmc in range(55, 65):
            return self.afternoon_lookup.loc[(60, hour)]['predicted_ffmc']
        elif lookup_ffmc in range(65, 71):
            return self.afternoon_lookup.loc[(70, hour)]['predicted_ffmc']
        elif lookup_ffmc in range(71, 73):
            return self.afternoon_lookup.loc[(72, hour)]['predicted_ffmc']
        else:
            return self.afternoon_lookup.loc[(lookup_ffmc, hour)]['predicted_ffmc']
