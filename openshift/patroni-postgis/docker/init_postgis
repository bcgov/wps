
if [[ (! -z "$APP_USER") &&  (! -z "$APP_PASSWORD") && (! -z "$APP_DATABASE")]]; then
    echo "Loading PostGIS extensions into $APP_DATABASE"
    psql "$1" -w -c "\c ${APP_DATABASE}" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
    # pgbackrest --config=/home/pgbackrest/pgbackrest.conf --pg1-path=/home/postgres/pgdata/pgroot/data --pg1-user=$APP_USER --pg1-database=$APP_DATABASE --stanza=demo-cluster-1 --log-path=/home/pgbackrest/log stanza-create
fi

# pgbackrest --config=/home/pgbackrest/pgbackrest.conf --pg1-path=/home/postgres/pgdata/pgroot/data

SSH_DIR=/home/postgres/.ssh
mkdir $SSH_DIR
chmod 700 $SSH_DIR

if [ -d /ssh_keys ]; then
   cp /ssh_keys/* $SSH_DIR
fi


if [ -f $SSH_DIR/config ]; then
   chmod 644  $SSH_DIR/id_rsa.pub
fi

if [ -f $SSH_DIR/id_rsa.pub ]; then
   chmod 644  $SSH_DIR/id_rsa.pub
fi

if [ -f $SSH_DIR/id_rsa ]; then
   chmod 600  $SSH_DIR/id_rsa
fi

if [ "$START_SSHD" = true ]; then

   SSH_CONF=/ssh_conf_template
   
   mkdir /home/postgres/sshd
   
   # Generate server keys if not existing
   if [ ! -f $SSH_CONF/ssh_host_ecdsa_key ]; then
      echo "Host key $SSH_CONF/ssh_host_ecdsa_key not found - generating a new one"
      ssh-keygen -q -N "" -t ecdsa -f $SSH_CONF/ssh_host_ecdsa_key
   fi
   if [ ! -f $SSH_CONF/ssh_host_ed25519_key ]; then
      echo "Host key $SSH_CONF/ssh_host_ed25519_key not found - generating a new one"
      ssh-keygen -q -N "" -t ed25519 -f $SSH_CONF/ssh_host_ed25519_key
   fi
   if [ ! -f $SSH_CONF/ssh_host_rsa_key ]; then
      echo "Host key $SSH_CONF/ssh_host_rsa_key not found - generating a new one"
      ssh-keygen -q -N "" -t rsa -f $SSH_CONF/ssh_host_rsa_key
   fi
#
   # Copy the keys and the config to the home directory  
   cp -r $SSH_CONF/* /home/postgres/sshd/

   # Copy authorized keys
   if [ -f $SSH_DIR/authorized_keys ]; then
      chmod 600  $SSH_DIR/authorized_keys
   fi

   chmod 600 /home/postgres/sshd/ssh_host*

   /usr/sbin/sshd -f /home/postgres/sshd/sshd_config

fi
